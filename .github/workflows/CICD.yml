name: MobiParkV2

on:
  pull:
    branches: ["development", "main"]

# permissions:
#   contents: read

jobs:
  Dependancy-check:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
      - name: "Dependency Review"
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  Build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
      - name: Install dependencies
        run: |
          cd v2 && dotnet restore
      - name: Build
        run: cd v2 && dotnet build --configuration Release --no-restore

  Integration-tests:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Install dotnet-ef
        run: |
          dotnet tool install --global dotnet-ef --version 9.0.10
          export PATH="$PATH:$HOME/.dotnet/tools"

      - name: Install dotnet NuGet packages
        run: |
          cd v2
          dotnet restore

      - name: Apply EF Core migrations
        run: |
          cd v2
          dotnet ef database update

      - name: Start ASP.NET server and wait for it
        run: |
          cd v2
          echo "Starting server..."
          dotnet run --urls "http://0.0.0.0:8000" --launch-profile Testing > server.log 2>&1 &

          echo "Waiting for server to be ready..."
          for i in {1..30}; do
              if curl --silent --fail http://localhost:8000/health > /dev/null; then
                  echo "Server is up!"
                  break
              else
                  echo "Server not ready yet... retrying ($i/30)"
                  sleep 3
              fi
          done

          # Final check
          if ! curl --silent --fail http://localhost:8000/health > /dev/null; then
              echo "Server failed to start after 30 attempts!"
              tail -n 50 server.log
              exit 1
          fi

      - name: Test vehicles
        run: |
          cd testing/integratieTesting
          pytest test_vehicles.py

      - name: Test payments
        run: |
          cd testing/integratieTesting
          pytest test_payments.py

      - name: Test login
        run: |
          cd testing/integratieTesting
          pytest test_login.py
      - name: Test profile
        run: |
          cd testing/integratieTesting
          pytest test_profile.py

      - name: Test register
        run: |
          cd testing/integratieTesting
          pytest test_register.py

      - name: Test parkinglots
        run: |
          cd testing/integratieTesting
          pytest test_parkinglots.py

      # - name: Test billing
      #   run: |
      #     cd testing/integratieTesting
      #     pytest test_billing.py

      - name: Debug server log if tests fail
        if: failure()
        run: |
          echo "---- LAST 100 LINES OF SERVER LOG ----"
          tail -n 100 v2/server.log || true

  Unit-tests:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install dotnet-ef
        run: |
          dotnet tool install --global dotnet-ef --version 9.0.10
          export PATH="$PATH:$HOME/.dotnet/tools"

      - name: Install dotnet NuGet packages
        run: |
          cd v2
          dotnet restore

      - name: Apply EF Core migrations
        run: |
          cd v2
          dotnet ef database update

      - name: Install test packages
        run: |
          cd testing/UnitTesting
          dotnet restore

      - name: Test vehicles
        run: |
          cd testing/UnitTesting
          dotnet test --filter "VehiclesServiceTests"

      - name: Test payments
        run: |
          cd testing/UnitTesting
          dotnet test --filter "PaymentServiceTests"

      - name: Test reservations
        run: |
          cd testing/UnitTesting
          dotnet test --filter "ReservationServiceTests"

      - name: Test authentication
        run: |
          cd testing/UnitTesting
          dotnet test --filter "AuthServiceTests"

      - name: Test parkinglots
        run: |
          cd testing/UnitTesting
          dotnet test --filter "ParkingLotServiceTests"
